<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AL GRANO - Sistema de Gestión</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="dashboard.css">

    <div class="sidebar">
        <div class="logo">
            <h1>NaturaCafé</h1>
            <p>Sistema de Gestión</p>
        </div>
        <div class="menu">
            <a href="dashboard.html" class="menu-item active">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="punto-venta.html" class="menu-item">
                <i class="fas fa-cash-register"></i>
                <span>Punto de Venta</span>
            </a>
            <a href="inventario.html" class="menu-item">
                <i class="fas fa-boxes"></i>
                <span>Inventario</span>
            </a>
            <a href="reportes.html" class="menu-item">
                <i class="fas fa-chart-bar"></i>
                <span>Reportes</span>
            </a>
            <a href="#" class="menu-item" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Cerrar Sesión</span>
            </a>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h2>Dashboard</h2>
            <div class="user-info">
                <div style="background-color: #8B4513; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <div id="username-display">Usuario</div>
                    <div style="font-size: 0.8rem; color: #666;">Administrador</div>
                </div>
            </div>
        </div>
        
        <div class="content">
            <div class="dashboard-cards">
                <div class="card sales">
                    <div class="card-header">
                        <div class="card-title">Ventas Hoy</div>
                        <div class="card-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                    <div class="card-value" id="sales-today">$0.00</div>
                    <div class="card-change">+0% vs ayer</div>
                </div>
                
                <div class="card inventory">
                    <div class="card-header">
                        <div class="card-title">Productos Bajos</div>
                        <div class="card-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                    <div class="card-value" id="low-stock">0</div>
                    <div class="card-change">Requieren atención</div>
                </div>
                
                <div class="card products">
                    <div class="card-header">
                        <div class="card-title">Total Productos</div>
                        <div class="card-icon">
                            <i class="fas fa-box"></i>
                        </div>
                    </div>
                    <div class="card-value" id="total-products">0</div>
                    <div class="card-change">En inventario</div>
                </div>
                
                <div class="card customers">
                    <div class="card-header">
                        <div class="card-title">Clientes Hoy</div>
                        <div class="card-icon">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="card-value" id="customers-today">0</div>
                    <div class="card-change">Transacciones</div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Productos Populares</h3>
                </div>
                
                <div class="product-grid" id="popular-products">
                    <p>Cargando productos...</p>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header">
                    <h3 class="section-title">Inventario Bajo</h3>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Categoría</th>
                            <th>Stock Actual</th>
                            <th>Stock Mínimo</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="low-stock-table">
                        <tr>
                            <td colspan="5" style="text-align: center;">Cargando inventario...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de notificaciones -->
    <div class="modal" id="notificationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Notificación</h3>
                <button class="close-modal" id="closeNotification">&times;</button>
            </div>
            <div id="notificationMessage"></div>
        </div>
    </div>

    <script>
        // Verificar sesión al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = sessionStorage.getItem('currentUser');
            
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }
            
            const userData = JSON.parse(currentUser);
            document.getElementById('username-display').textContent = userData.username;
            
            // Cargar datos del dashboard
            loadDashboardData();
            
            // Cerrar sesión
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                sessionStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            });
        });
        
        function loadDashboardData() {
            // Cargar estadísticas
            fetch('api/dashboard-stats.php')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('sales-today').textContent = '$' + data.sales_today;
                    document.getElementById('low-stock').textContent = data.low_stock_count;
                    document.getElementById('total-products').textContent = data.total_products;
                    document.getElementById('customers-today').textContent = data.customers_today;
                })
                .catch(error => console.error('Error:', error));
            
            // Cargar productos populares
            fetch('api/popular-products.php')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('popular-products');
                    container.innerHTML = '';
                    
                    data.forEach(product => {
                        const card = document.createElement('div');
                        card.className = 'product-card';
                        card.innerHTML = `
                            <div class="product-info">
                                <div class="product-name">${product.nombre}</div>
                                <div class="product-price">${product.precio}</div>
                                <div class="product-stock">Stock: ${product.stock} unidades</div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                })
                .catch(error => console.error('Error:', error));
            
            // Cargar inventario bajo
            fetch('api/low-stock.php')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('low-stock-table');
                    tbody.innerHTML = '';
                    
                    data.forEach(item => {
                        const row = document.createElement('tr');
                        const statusClass = item.stock_actual <= 3 ? 'status-out-of-stock' : 'status-low-stock';
                        const statusText = item.stock_actual <= 3 ? 'Crítico' : 'Bajo Stock';
                        
                        row.innerHTML = `
                            <td>${item.nombre}</td>
                            <td>${item.categoria}</td>
                            <td>${item.stock_actual}</td>
                            <td>${item.stock_minimo}</td>
                            <td><span class="status ${statusClass}">${statusText}</span></td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>